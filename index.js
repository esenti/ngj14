var levelText = [];

levelText[0] = "Dear Eric,\n\
we have to act. The agency went crazy,\n\
everyone who sends an email with any of their\n\
☃chosen☃ words might be soon ☃dead☃.\n\
I sent you some software:\n\
an algorithm marks ☃dangerous☃ words,\n\
and two ☃viruses☃ that eat charcters from\n\
agencies stream.\n\
Try not to leak anything, but at least be sure\n\
marked words wont pass.\n\
\n\
Best regards,\n\
☃Merlin☃";

levelText[1] = "Dear ☃Stephanie☃,\n\
my heard is like ☃burst☃ wiht some ☃SEMTEX☃.\n\
I cannot keeep this ☃conspiracy☃ any longer.\n\
I LOVE YOU.\n\
Everything in you, your ☃face☃, your hair,\n\
even your ☃sneakers☃ painted in flowers.\n\
I can only hope, you feel the same.\n\
If so, maybe i could take you for the newest\n\
☃Pixar movie☃\n\
My phone number: ☃(+48) 456 354 158 ext 546324☃.\n\
\n\
Trully yours,\n\
☃Bob☃";

levelText[2] = "Eric,\n\
I think I got into their trap.\n\
I assume I will be soon found as ☃victim☃\n\
of some ☃lethal incident☃. Or rather my\n\
☃corpse☃ will never be found.\n\
I also think their ☃firewall☃ will get some\n\
☃response☃ for my ☃viruses☃ very soon, and \n\
these will loose most of their effectivenes.\n\
Your on your own.\n\
Act ☃smart☃, fight this ☃threat☃ for\n\
☃freedom☃, and do not get ☃killed☃.\n\
\n\
I hope we will meet again,\n\
☃Merlin☃";

levelText[3] = "Litwo! ☃Ojczyzno moja!☃ ty jestes jak zdrowie.\n\
Kto cie stracil. Dzis ☃pieknosc☃ twa w calej ozdobie\n\
Widze i opisuje, bo tesknie po tobie.\n\
\n\
Panno Swieta, co jasnej bronisz Czestochowy\n\
I w Ostrej ☃swiecisz☃ Bramie! Ty, co grod zamkowy\n\
Nowogrodzki ochraniasz z jego wiernym ludem!\n\
Jak mnie dziecko do zdrowia powrocilas ☃cudem☃\n\
(Gdy od placzacej matki pod Twoja opieke\n\
Ofiarowany, ☃martwa podnioslem powieke☃\n\
I zaraz moglem pieszo do Twych swiatyn progu\n\
Isc za wrocone zycie podziekowac Bogu),\n\
Tak nas powrocisz cudem na Ojczyzny lono.\n\
Tymczasem przenos moje dusze uteskniona\n\
Do tych pagorkow lesnych, do tych lak zielonych,\n\
Szeroko nad blekitnym Niemnem rozciagnionych;\n\
Do tych pol malowanych zbozem rozmaitem,\n\
Wyzlacanych pszenica, posrebrzanych zytem;\n\
Gdzie bursztynowy swierzop, gryka jak snieg biala,\n\
Gdzie panienskim rumiencem dziecielina pala,\n\
A wszystko przepasane, jakby wstega, miedza\n\
Zielona, na niej z rzadka ciche grusze siedza.\n\
\n\
Srod takich pol przed laty, nad brzegiem ruczaju,\n\
Na pagorku niewielkim, we brzozowym gaju,\n\
Stal dwor szlachecki, z drzewa, lecz podmurowany;\n\
Swiecily sie z daleka pobielane sciany,\n\
Tym bielsze, ze odbite od ciemnej zieleni\n\
Topoli, co go bronia od wiatrow jesieni.\n\
Dom mieszkalny niewielki, lecz zewszad chedogi,\n\
I stodole mial wielka, i przy niej trzy stogi\n\
Uzatku, co pod strzecha zmiescic sie nie moze;\n\
Widac, ze okolica obfita we zboze,\n\
I widac z liczby kopic, co wzdluz i wszerz smugow\n\
Swieca gesto jak gwiazdy, widac z liczby plugow\n\
Orzacych wczesnie lany ogromne ugoru,\n\
Czarnoziemne, zapewne nalezne do dworu,\n\
Uprawne dobrze na ksztalt ogrodowych grzadek:\n\
Ze w tym domu dostatek mieszka i porzadek.\n\
\n\
Brama na wciaz otwarta przechodniom oglasza,\n\
Ze goscinna i wszystkich w goscine zaprasza.\n\
\n\
Wlasnie dwokonna bryka wjechal mlody panek\n\
I obieglszy dziedziniec zawrocil przed ganek,\n\
Wysiadl z powozu; konie porzucone same,\n\
Szczypiac trawe ciagnely powoli pod brame.\n\
We dworze pusto, bo drzwi od ganku zamknieto\n\
Zaszczepkami i kolkiem zaszczepki przetknieto.\n\
Podrozny do folwarku nie biegl slug zapytac;\n\
Odemknal, wbiegl do domu, pragnal go powitac.\n\
Dawno domu nie widzial, bo w dalekim miescie\n\
Konczyl nauki, konca doczekal nareszcie.\n\
Wbiega i okiem chciwie sciany starodawne\n\
Oglada czule, jako swe znajome dawne.\n\
Tez same widzi sprzety, tez same obicia,\n\
Z ktoremi sie zabawiac lubil od powicia;\n\
Lecz mniej wielkie, mniej piekne, niz sie dawniej zdaly.\n\
I tez same portrety na scianach wisialy.\n\
Tu Kosciuszko w czamarce krakowskiej, z oczyma\n\
Podniesionymi w niebo, miecz oburacz trzyma;\n\
Takim byl, gdy przysiegal na stopniach oltarzow,\n\
Ze tym mieczem wypedzi z Polski trzech mocarzow\n\
Albo sam na nim padnie. Dalej w polskiej szacie\n\
Siedzi Rejtan zalosny po wolnosci stracie,\n\
W reku trzymna noz, ostrzem zwrocony do lona,\n\
A przed nim lezy Fedon i zywot Katona.\n\
Dalej Jasinski, mlodzian piekny i posepny,\n\
Obok Korsak, towarzysz jego nieodstepny,\n\
Stoja na szancach Pragi, na stosach Moskali,\n\
Siekac wrogow, a Praga juz sie wkolo pali.\n\
Nawet stary stojacy zegar kurantowy\n\
W drewnianej szafie poznal u wniscia alkowy\n\
I z dziecinna radoscia pociagnal za sznurek,\n\
By stary Dabrowskiego uslyszec mazurek.\n\
\n\
Biegal po calym domu i szukal komnaty,\n\
Gdzie mieszkal, dzieckiem bedac, przed dziesieciu laty.\n\
Wchodzi, cofnal sie, toczyl zdumione zrenice\n\
Po scianach: w tej komnacie mieszkanie kobiĂŠce?\n\
Ktoz by tu mieszkal? Stary stryj nie byl zonaty,\n\
A ciotka w Petersburgu mieszkala przed laty.\n\
To nie byl ochmistrzyni pokoj! Fortepiano?\n\
Na niem noty i ksiazki; wszystko porzucano\n\
Niedbale i bezladnie; nieporzadek mily!\n\
Niestare byly raczki, co je tak rzucily.";

// the initial seed
Math.seed = parseInt(Math.random() * 1000);

// in order to work 'Math.seed' must NOT be undefined,
// so in any case, you HAVE to provide a Math.seed
Math.seededRandom = function(max, min) {
	max = max || 1;
	min = min || 0;

	Math.seed = (Math.seed * 9301 + 49297) % 233280;
	var rnd = Math.seed / 233280;

	return min + rnd * (max - min);
}

var isInSnowmanState = false;

var gameSpeed = 0.01;
var gameTime = 80000;

var startLife = 100;

var VirNameBase=new Array("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "4K", "4096", "5lo", "Abraxas", "Acid", "Acme", "ABC", "AIDS", "AntiCMOS", "Bomber", "Commander", "flu", "Byte", "Bandit", "Christmas", "Commwarrior", "Conficker", "Creeper", "Eliza", "ILOVEYOU", "INIT", "Jerusalem", "worm", "Lamer", "Exterminator", "Garfield", "Michelangelo", "Navidad", "Boot", "Techno", "Whale", "Doom", "Sasser", "Storm");
var VirNameDot=new Array(".",".",".",".",".","_",":","-","+");
var anims=new Array("shake","swing","tada","wobble");

function generateVirusName() {
	function keep21(a,b) {
		b = a+b;
		if (b.length <= 21) { vextended++; return b; }
		return a;
	}
	virus = VirNameBase[Math.floor((Math.seededRandom()*VirNameBase.length))]; var vextended = 0;
	while (vextended ==0) {
		if (Math.seededRandom() > 0.8) { virus = keep21(virus, VirNameDot[Math.floor((Math.seededRandom()*VirNameDot.length))] + String.fromCharCode(65+Math.floor(Math.seededRandom()*4)) ); }
		if (Math.seededRandom() > 0.9) { virus = keep21(virus, VirNameDot[Math.floor((Math.seededRandom()*VirNameDot.length))] + Math.floor(Math.seededRandom()*9999) ); }
		else if (Math.seededRandom() > 0.80) { virus = keep21(virus, VirNameDot[Math.floor((Math.seededRandom()*VirNameDot.length))] + "19" + Math.floor(70+Math.seededRandom()*29) ); }
		else if (Math.seededRandom() > 0.75) { virus = keep21(virus, VirNameDot[Math.floor((Math.seededRandom()*VirNameDot.length))] + "20" + Math.floor(Math.seededRandom()*14) ); }
		else if (Math.seededRandom() > 0.65) { virus = keep21(virus, VirNameDot[Math.floor((Math.seededRandom()*VirNameDot.length))] + Math.floor(Math.seededRandom()*9) ); }
		if (Math.seededRandom() > 0.8) { virus = keep21(virus, VirNameDot[Math.floor((Math.seededRandom()*VirNameDot.length))] + VirNameBase[Math.floor((Math.seededRandom()*VirNameBase.length))] ); }
	}
	return virus;
}

var viruses = []

for(var i = 0; i < 24; i++) {
	viruses[i] = generateVirus();
}

function generateVirus() {
	var name = generateVirusName();

	var virus = {
		name: name,
		removeAnimation: ['flipOutY', 'fadeOutDown', 'fadeOutDownBig', 'bounceOut', 'rotateOut', 'rotateOutDownLeft', 'rotateOutDownRight', 'hinge', 'rollOut'][Math.floor(Math.seededRandom() * 9)],
		typeString: '',
		sound: new Audio(name.substring(0, 4).toLowerCase() + '.mp3')
	}

	var rr = Math.seededRandom();
	if (rr < 0.1) {
		virus.lowerCase = true;
		virus.typeString = '<em>lower</em>';
	} else if (rr < 0.2) {
		virus.upperCase = true;
		virus.typeString = '<em>upper</em>';
	} else if (rr < 0.27) {
		virus.typeString = '<em>all</em>';
	} else {

		var r = Math.seededRandom();
		if(r <= 0.2) {
			virus.typeString += 'AEIOU';
			virus.letter = 'vowel';
		} else if(r <= 0.5) {
			virus.typeString += 'BCDFG';
			virus.letter = 'consonant';
		}

		if(r >= 0.5 && r <= 0.7) {
			virus.nonLetter = true;
			virus.typeString += '?.!-';
		}

		if(r >= 0.7) {
			virus.numbers = true;
			virus.typeString += '12345';
		}

	}

	virus.cooldown = Math.round(Math.seededRandom() * 15 + 1);

	if(Math.seededRandom() < 0.3) {
		virus.removeFront = Math.round(Math.seededRandom() * 10 + 5);
	}
	if(Math.seededRandom() < 0.3) {
		virus.removeBack = Math.round(Math.seededRandom() * 10 + 5);
	}

	if (virus.removeFront || virus.removeBack) {
		virus.probability = Math.round(Math.seededRandom() * 50 + 50);
	} else {
		virus.probability = Math.round(Math.seededRandom() * 90 + 10);
	}

	return virus;
}

// viruses.a = {
// 	name: generateVirusName(),
// 	typeString: 'BCDFG + 0-9',
// 	removeAnimation: 'rotateOut',
// 	removeFront: 10,
// 	letter: 'vowel',
// 	numbers: true,
// 	cooldown: 5
// };

// viruses.b = {
// 	name: generateVirusName(),
// 	typeString: 'AEIOU',
// 	removeAnimation: 'fadeOutDown',
// 	removeBack: 5,
// 	direction: "back",
// 	letter: 'consonant',
// 	cooldown: 15
// };

// viruses.c = {
// 	name: generateVirusName(),
// 	typeString: '<- 50% ->',
// 	removeAnimation: 'flipOutY',
// 	removeFront: 10,
// 	removeBack: 10,
// 	probability: 50,
// 	letter: true,
// 	nonLetter: true,
// 	numbers: true,
// 	cooldown: 1000000
// };

// viruses.d = {
// 	name: generateVirusName(),
// 	typeString: '0-9',
// 	numbers: true,
// 	probability: 50,
// 	removeAnimation: 'rollOut',
// 	cooldown: 0.1
// };

// viruses.e = {
// 	name: generateVirusName(),
// 	typeString: '☃',
// 	removeAnimation: 'flipOutY',
// 	letter: true,
// 	nonLetter: true,
// 	numbers: true,
// 	cooldown: 1000000
// };

// viruses.fuck = {
// 	name: generateVirusName(),
// 	typeString: 'A-Z',
// 	removeAnimation: 'flipOutY',
// 	letter: true,
// 	cooldown: 10,
// 	probability: 30,
// };

// viruses.shit = {
// 	name: generateVirusName(),
// 	typeString: 'AEIOU',
// 	removeAnimation: 'flipOutY',
// 	letter: 'vowel',
// 	cooldown: 5,
// 	nonLetter: true,
// 	removeFront: 20
// };

// viruses.dick = {
// 	name: generateVirusName(),
// 	typeString: 'BFG9000',
// 	removeAnimation: 'flipOutY',
// 	letter: 'consonant',
// 	cooldown: 5,
// 	nonLetter: true,
// 	removeFront: 20
// };

// viruses.cunt = {
// 	name: generateVirusName(),
// 	typeString: 'Ass',
// 	removeAnimation: 'flipOutY',
// 	letter: 'consonant',
// 	cooldown: 5,
// 	nonLetter: true,
// 	removeFront: 20,
// 	direction: 'mutherfucker'
// };

function frame() {
	now = Date.now();
	delta = (now - then) / 1000;
	then = now;

	currentState.update(delta)
}

function setState() {

	var args = Array.prototype.slice.call(arguments);

	var state = args.shift();

	if(typeof currentState !== 'undefined') {
		currentState.exit();
	}

	state.enter.apply(state, args);
	currentState = state;
}

$(function() {


	now = then = Date.now();

	toLetter = 0;
	waitingForSpace = false;

	setState(MenuState);
	// setState(AlbumState);

	window.requestAnimationFrame(frame);
});

function getLetterIterator(level) {

	var i = 0

	return function() {
		var letter = levelText[level][i++];
		if (letter == "☃") {
			isInSnowmanState = !isInSnowmanState;
			letter = levelText[level][i++];
		}
		return letter;
	}
}

function launchVirus(virus) {

	virus.sound.play();

	var removedCounter = 0;

	var removedFromFront = 0;
	var toRemoveFromBack = [];

	forEveryLetter( function($el, text) {

		if (virus.probability && Math.seededRandom() * 100 > virus.probability) {
			return;
		}

		if (virus.removeFront && removedFromFront >= virus.removeFront) {
			return;
		}

		if (virus.lowerCase && !isLowerCase($el, text)) {
			return;
		}

		if (virus.upperCase && !isUpperCase($el, text)) {
			return;
		}

		if ((virus.letter && isLetter($el, text) && (
				(virus.letter == 'vowel' && isVowel($el, text)) ||
				(virus.letter == 'consonant' && !isVowel($el, text)) ||
				(virus.letter == true))) ||
			(virus.nonLetter && !isLetter($el, text)) ||
			(virus.numbers && isNumber($el, text)) ||
			(virus.notNumber && !isNumber($el, text)) ||
			(!virus.letter && !virus.nonLetter && !virus.numbers && !virus.notNumber)) {

			if (virus.removeBack) {
				toRemoveFromBack.push({$el: $el, animation: virus.removeAnimation});
				removedCounter++;
			} else {
				removedFromFront++;
				removedCounter++;
				removeWithAnimation($el, virus.removeAnimation);
			}

			return;
		}

	});

	if (virus.removeBack) {
		if (virus.removeFront) {
			for (var i = 0; i < Math.min(virus.removeFront, toRemoveFromBack.length); ++i) {
				removeWithAnimation(toRemoveFromBack[i].$el, toRemoveFromBack[i].animation);
			}
		}

		for (var i = Math.max(0, toRemoveFromBack.length - virus.removeBack); i < toRemoveFromBack.length; ++i) {
			removeWithAnimation(toRemoveFromBack[i].$el, toRemoveFromBack[i].animation);
		}
	}

	return removedCounter;

}

function forEveryLetter(callback) {
	$('.line .alive').each(function(i, e) {
		var $el = $(this);
		var text = $el.text();
		callback($el, text);
	});
}

function removeWithAnimation($el, animation) {
	$el.animateCSS(animation, 0, function(a) {
		$(this).addClass("removed");
		$(this).removeClass("alive");

		$('.line').each(function(i, e) {
			var keep = false;

			$(this).find('.letter').each(function() {
				if($(this).hasClass('alive')) {
					keep = true;
				}
			});

			if(!keep) {
				$(this).remove();
			}
		});
	});
}

function isNumber($el, text) {
	return !isNaN(text);
}

function isLetter($el, text) {
	return !isNumber() && text.toUpperCase() !== text.toLowerCase();
}

function isVowel($el, text) {
	var l = text.toUpperCase();
	return l == 'E' || l == 'Y' || l == 'U' || l == 'O' || l == 'A' || l == 'I';
}

function isUpperCase($el, text) {
	return text.toUpperCase() === text;
}

function isLowerCase($el, text) {
	return text.toLowerCase() === text;
}

function makeButton(virus, id, giraffe) {
	var strType = virus.typeString;
	// var propabilityPrefix = (virus.removeFront ? virus.removeFront : '-') + '/' + (virus.removeBack ? virus.removeBack : '-');
	// if (propabilityPrefix == '-/-') {
	// 	propabilityPrefix = '';
	// }
	var strProbability = (virus.probability ? virus.probability + '%' : '100%');
	var strName = virus.name;
	//var strDirection = virus.removeFront ? (virus.removeBack ? "both" : "front") : (virus.removeBack ? "back" : "random");
	var strDirection = virus.removeFront ? (virus.removeBack ? (virus.removeFront + " front, " + virus.removeBack + " back") : (virus.removeFront + " front")) : (virus.removeBack ? (virus.removeBack + " back") : "");
	var strCooldown = virus.cooldown > 9999 ? '&infin;' : virus.cooldown + 's';

	var newButton = '<a data-virus-id="' + id + '" class="button ' + (virus.taken && giraffe ? 'green' : 'blue') + '">' +
		'<div class="cldwrapper">' +
		'<table><tr><td class="bttopleft">' + strType +
		'</td><td class="bttopright">' + strProbability + '</td></tr>' +
		'<tr><td colspan=2 class="btmid">' + strName + '</td></tr>' +
		'<tr><td class="bttopleft">' + strDirection + '</td>' +
		'<td class="btbottomright cooldownStr">' + strCooldown + '</td></tr></table></div></a>';

	return newButton;
}
